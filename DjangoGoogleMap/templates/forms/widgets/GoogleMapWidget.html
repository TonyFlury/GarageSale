
<div id="id_{{ widget.name }}_map">
    <input type="text" name="{{ widget.name }}" id="id_{{ widget.name }}"
           {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}"{% endif %} hidden/>
    <div id="id_{{ widget.name }}_map_wrapper" style="width: 100%; height:100%;"></div>

    <script type="text/javascript" async src="https://maps.googleapis.com/maps/api/js?key={{ widget.attrs.API_KEY }}&libraries=marker,places&callback=initMap"></script>

        <script type="text/javascript">
        let mapInst;
        let marker;

        function initMap() {

            const field = document.getElementById('id_{{ widget.name }}');
            if (field == null) {
                console.error("Missing form element 'id_{{ widget.name }}' - unable to display Google map widget.")
                return ;
            }

            mapInst = new google.maps.Map(document.getElementById('id_{{ widget.name }}_map_wrapper'), {
                center: {{ widget.attrs.center | safe }}, // Default center point
                zoom: {{ widget.attrs.defaultZoom }},
                mapId: '{{ widget.attrs.MAP_ID }}',
                controlSize: 20,
                scaleControl: true,
                fullscreenControl: false,
                zoomControl: true,
                zoomControlOptions: {
                  position: google.maps.ControlPosition.BLOCK_START_INLINE_END
                },
                streetViewControl: false,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                    mapTypeIds: ["roadmap", "satellite", "hybrid"],
                },

            });

            {% if  'bounds' in widget.attrs %}
                mapInst.setOptions({
                    restriction: {
                            latLngBounds: {{ widget.attrs.bounds | safe }},
                            strictBounds : {% if 'strictBounds' in widget.attrs %}true{% else %}false{% endif %}
                    }} );
            {%  endif %}

            if  (field.value != null && field.value !== '')
            {
                console.log(field.value);
                mapInst.setZoom( {{ widget.attrs.autoZoomLevel}} );
                mapInst.panTo(JSON.parse(field.value))
                addMarker(JSON.parse(field.value));
            }

            // Add a click listener to the map
            mapInst.addListener('click', (event) => {
                addMarker(event.latLng);
            });
        }

        /** Attempt to build generic find API to solve what appaers to be a coupling problem **/
        function findOnMap( data, callback ){
              var service = new google.maps.places.PlacesService(mapInst);
              service.findPlaceFromQuery({query: data,
                                          fields: ["name", "geometry"]}, callback);
        }

        function recenterTo(location) {
            mapInst.panTo(location);
            if (mapInst.zoom < {{ widget.attrs.autoZoomLevel }}) {
                mapInst.setZoom({{ widget.attrs.autoZoomLevel }});
            }
        }

        function addMarker(location) {
            mapInst.panTo(location);

            if (mapInst.zoom < {{ widget.attrs.autoZoomLevel }}) {
                mapInst.setZoom(Math.min(map.zoom+{{ widget.attrs.zoomStep }}, {{ widget.attrs.autoZoomLevel }} ));
                return;
            }
            if (marker) {
                marker.setMap(null); // Remove the previous marker
            }
            marker = new google.maps.marker.AdvancedMarkerElement({
                map: mapInst,
                position: location,
                title: "{{widget.attrs.title}}"
            });
            console.log(JSON.stringify(location), 'Marked');
            document.getElementById('id_{{ widget.name }}').value=JSON.stringify(location);
        }
    </script>
</div>