{% extends "accounts_base.html" %}
{% load static %}
{% load user_management_tags %}
{% load team_page_tags %}

{% block Title %}
    Brantham Garage Sale - Banking Transactions
{% endblock %}

{% block PageStyles %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'team_pages/styles/team_page.css' %}" xmlns="http://www.w3.org/1999/html">
    <style>

        div#buttons {
            display: flex;
            padding: 1rem;
            margin-left:0px;

            input[type=button] {
                border-radius: 15px;
                border: thin solid black;
                box-shadow: 2px 2px 2px black;
            }
            input[type=button]:last-child { margin-left: auto;}

            input#toggle_collapse[value="Collapse All"] {  box-shadow: inset 2px 2px 2px black;}
            input#toggle_edit:not([value="Edit"]) {  box-shadow: inset 2px 2px 2px black; background-color: red; }

        }

        div#Content {font-size:80%}

        div#transactions { width: 80%;}

        header {background-color: #ddd; font-weight: bold;font-size: 120%; border-bottom: 1px solid black;}

        table {
            margin-left: auto;
            margin-right: auto;
            width: 95%;
            }

        table tr.row:last-child td {border-bottom: 1px solid black;}

        tr:not(.expanded).child  {display: none;}
        tr.parent:not(.expanded) > td:first-child {
            background: url("{% static 'GarageSale/images/icons/expand-down-double-svgrepo-com.svg' %}") no-repeat center;
            background-size: 1.5rem 1.5rem;
        }

        tr.expanded.child {display: table-row;}
        tr.expanded.child > td:nth-child(2) {
            background: url('{% static "GarageSale/images/icons/corner-down-right-svgrepo-com.svg" %}') no-repeat center;
                                                                background-size: 1rem 1rem; }
        tr.expanded.parent > td:first-child {
            background: url('{% static "GarageSale/images/icons/expand-up-double-svgrepo-com.svg" %}') no-repeat center;
            background-size: 1rem 1rem;
        }

        tr.odd {background-color: lightblue;}
        tr.even {background-color: white;}

        tr:not(.child) td {border-bottom: 1px dashed black; border-right: 1px dashed black;}
        tr.child.even, tr.child.odd {background-color: white}
        tr.child td {border:none}
        tr.child:has(+ tr:not(.child)) td {border-bottom: 1px double black;}
        tr.child td:nth-child(n+3):nth-child(-n+5){background-color:
                lightgray; border-right: 1px dashed black; border-bottom: 1px dashed black;}

        tr th {background-color: #ddd; font-weight: bold;font-size: 120%; border-bottom: 1px solid black;}
        th, td {padding: 0.5rem 0.5rem; border-right: 1px dashed black;}
        tr td.date {text-align: right;}


        tr:not(.child).editing {background-color: orangered;}
        tr.child.editing td:nth-child(n+3):nth-child(-n+5){background-color:
                orangered; border-right: 1px dashed black; border-bottom: 1px dashed black;}

        .edit_button {display: none;
            background: url('{% static "GarageSale/images/icons/edit-svgrepo-com.svg" %}') no-repeat center;
            background-size: 2rem; height: 2rem;
            padding: 0 1rem;}

        .revert_button {display:none;
            background: url('{% static "GarageSale/images/icons/revert-svgrepo-com.svg" %}') no-repeat center;
            background-size: 2rem; height: 2rem;
            padding: 0 1rem;}

        .link_button {display:none;
            background: url('{% static "GarageSale/images/icons/link-svgrepo-com.svg" %}') no-repeat center;
            background-size: 2rem; height: 2rem;
            padding: 0 1rem;}

        tr.editing .edit_button {display:table-cell;
            background: url('{% static "GarageSale/images/icons/save-svgrepo-com.svg" %}') no-repeat center;
            background-size: 2rem; height: 2rem;
            padding: 0 1rem;}

        tr.editing .revert_button {display: table-cell;}
        tr:not(.editing) .revert_button {display: none;}

        div.step-links {
            position:fixed;
            bottom:10px;
            border: 1px solid black;
            border-radius: 1rem;
            padding: 1rem;
            display:flex;
            width:70%;
            justify-content: space-between;
        }
    </style>
{% endblock %}

{% block header %}
<div  class="breadcrumb">
    {% block breadcrumb %}
        {% breadcrumb %}
    {% endblock%}
</div>
{% endblock %}



{% block SnappableSections %}

<script language="javascript">

    function _decimal2int(decimal_string) {
        /* Convert a decimal string to an integer */
        let parts = decimal_string.split(".");
        if (parts.length === 1)
            return parseInt(decimal_string)*100;
        else
            parts[1] = parts[1].padEnd(2, '0');
        return parseInt(decimal_string.split(".").join(''));
    }

    function _int2decimal(integer) {
        /* Convert an integer to a decimal string */
        return String(integer / 100) + "." + String(integer % 100).padStart(2, '0');
    }

    function _revert_edit_on_child(row_element) {
        /* Discard any edits made to a child row */
        const table = document.getElementById("transactions");
            if (row_element.classList.contains("new")) {
                table.deleteRow(row_element.rowIndex);
                return;
            }
            let id = row_element.id;
            let parent_id = row_element.getAttribute("parent_id");
            let parent_row = document.getElementById(parent_id);
            let type = (parent_row.querySelector(".debit").innerText !== "")? "debit":"credit";

            let name_element = document.getElementById(id + "__name");
            let amount_element = document.getElementById(id + "__" + type);
            name_element.innerHTML = name_element.children[0].value;
            amount_element.innerHTML = amount_element.children[0].value;
    }

    function _revert_edit_on_non_child(row_element) {
        /* Discard any edits made to a non-child row */
        let name_element = document.getElementById(id + "__name");
        let category_element = document.getElementById(id + "__category");
        name_element.innerHTML = name_element.children[0].value;
        category_element.innerHTML = category_element.children[0].value;
    }

    function revert_edit(row_element) {
        /* Revert any edits made to a row - invoked when the revert button is clicked*/
        const table = document.getElementById("transactions");
        let id = row_element.id

        row_element.classList.remove("editing");

        if (row_element.classList.contains("child"))
            _revert_edit_on_child(row_element);
        else
            _revert_edit_on_non_child(row_element);
    }

    function _save_child_edit(row_element, parent_row) {
        /* Save any edits made to the row - invoked when the save button is clicked*/
        let type = (parent_row.querySelector(".debit").innerText !== "") ? "debit" : "credit";

        let id = null, name_element = null, amount_element = null;
        if (row_element.classList.contains("new")) {
            id = null;
            name_element = document.getElementById(parent_row.id + "__split_name");
            amount_element = document.getElementById(parent_row.id + "__split_" + type);
        } else {
            id = row_element.id
            name_element = document.getElementById(id + "__name_edit");
            amount_element = document.getElementById(id + "__" + type + "_edit");
        }

        let amount_max = _decimal2int(parent_row.getAttribute("remaining_" + type)) + _decimal2int(amount_element.defaultValue);
        let amount_input = _decimal2int(amount_element.value);
        if (amount_input > amount_max)
        {
            amount_element.setCustomValidity("Amount exceeds available balance");
            amount_element.reportValidity();
            return;
        }

        let url = `/Account/edit_split/${id}/`;

        if (row_element.classList.contains("new"))
            url = `/Account/add_split/${parent_row.id}/`;

        let request = new Request( url,
            {method: "PUT", headers: {"X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"},
            body: JSON.stringify({name: name_element.value, [type]: amount_element.value})
            });
        fetch(request).
                then(response => {
                    if (!response.ok)
                        console.log("Error: " + response.statusText);
                    return response.json() }).
            then(data => {
                console.log(data)
                name_element.parentElement.innerHTML = name_element.value;
                amount_element.parentElement.innerHTML = amount_element.value;
                row_element.classList.remove("editing");
                let remaining = amount_max - _decimal2int(amount_element.value);
                parent_row.setAttribute("remaining_" + type, _int2decimal(remaining));
                name_element.remove()
                amount_element.remove()
                if (row_element.classList.contains("new")) {
                    row_element.classList.remove("new", "editing");
                    row_element.classList.add("child");
                    row_element.setAttribute("parent_id", parent_row.id);
                    row_element.id = data.id;
                    name_element.id = `${row_element.id}__name`;
                    amount_element.id = `${row_element.id}__${type}`;

                    const edit_button = row_element.querySelector(".edit_button");
                    edit_button.addEventListener("click", edit_transaction);
                    edit_button.id = id + "__edit"

                    const revert_button = row_element.querySelector(".revert_button");
                    revert_button.addEventListener("click", function (event) {
                        revert_edit(event.target.parentElement)
                    })

                    let child_rows = document.querySelectorAll(".row.child[parent_id='" + t_id + "']");
                    for (let j=0; j<child_rows.length; j++)
                        child_rows[j].classList.add("expanded");

                    revert_button.id = id + "__revert"
                }
            });
    }

    function _save_non_child_edit(row_element) {
        /* Save any edits made to the row - invoked when the save button is clicked*/
        let id = row_element.id
        let name_element = document.getElementById(id + "__name_edit");
        let category_element = document.getElementById(id + "__category_edit");

        let request = new Request(`/Account/edit_transaction/${id}/`,
            {method: "PUT", headers: {"X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"},
            body: JSON.stringify({name: name_element.value, category: category_element.value})
            });
        fetch(request).
                then(response => {
                    if (!response.ok)
                        console.log("Error: " + response.statusText);
                    return response.json() }).
            then(data => {
                console.log(data)
                name_element.parentElement.innerHTML = name_element.value;
                category_element.parentElement.innerHTML = category_element.value;
                row_element.classList.remove("editing");
                name_element.remove()
                category_element.remove()
            });
    }

    function save_edit(row_element) {
        /* Save any edits made to the row - invoked when the save button is clicked*/
        if (!row_element.classList.contains("child"))
            _save_non_child_edit(row_element)
        else {
            let parent_id = row_element.getAttribute("parent_id");
            let parent_row = document.getElementById(parent_id);
            _save_child_edit(row_element, parent_row);
        }
    }

    function _build_DOM_element(name, options)
    {
       let element = document.createElement(name)
        for (let key in options) {
            element[key] = options[key];
        }
        return element;
    }

    function _edit_child(id, parent_row) {
        const name_element = document.getElementById(`${id}__name`);

        let type = (parent_row.querySelector(".debit").innerText !== "")? "debit":"credit";
        const amount_element = document.getElementById(`${id}__${type}`);

        let name = _build_DOM_element("input", { id : `${id}__name_edit`,
                                                type: "text",
                                                required: true,
                                                defaultValue: name_element.innerText,
                                                value: name_element.innerText});
        name_element.innerHTML = "";
        name_element.appendChild(name);

        let amount = _build_DOM_element("input", { id : `${id}__${type}_edit`, type:"text",
                                                    required: true,
                                                    defaultValue: amount_element.innerText,
                                                    value:amount_element.innerText});
        amount_element.innerHTML = "";
        amount_element.appendChild(amount);
    }

    function _create_child_row(parent_row) {

        const table = document.getElementById("transactions");

        let new_row = table.insertRow(parent_row.rowIndex+1)
        new_row.classList.add("child","row",'editing','expanded', 'new');
        new_row.setAttribute("parent_id", parent_row.id);
        new_row.classList.add("editing");

        let blank_cells = `<td class="col"></td><td class="col date"></td><td class="col name"></td><td class="col debit"></td><td class="col credit"></td><td class="col balance"></td><td class="col category"></td><td class='edit_button'></td><td class='revert_button'></td><td class='link_button'></td>`
        new_row.innerHTML = blank_cells;

        let type = (parent_row.querySelector(".debit").innerText !== "")? "debit":"credit";

        let name_element = _build_DOM_element("input", { id: `${parent_row.id}__split_name`, type:"text",
                                                        required:true });
        let name_cell = new_row.querySelector('.col.name');
        name_cell.innerHTML = name_element.outerHTML;

        let amount_element = _build_DOM_element("input", { id: `${parent_row.id}__split_${type}`, type:"text", required:true,
                                                            defaultValue: "0.00"});
        amount_element.classList.add(type);
        new_row.querySelector(`.${type}`).innerHTML = amount_element.outerHTML;


        /* Need to set the save and revert buttons */
        let edit_button = new_row.querySelector(".edit_button");
        edit_button.addEventListener("click", edit_transaction);

        let revert_button = new_row.querySelector(".revert_button");
        revert_button.addEventListener("click", function(event) {revert_edit(event.target.parentElement)});
    }


    function _edit_non_child(row_id) {
        const name_element = document.getElementById(row_id + "__name");
        const category_element = document.getElementById(row_id + "__category");

        let name = _build_DOM_element("input", { id : `${row_id}__name_edit`,
                                                type: "text",
                                                required: true,
                                                value: name_element.innerText});

        name_element.innerHTML = "";
        name_element.appendChild(name);

        let category = _build_DOM_element("input", { id : `${row_id}__category_edit`, type:"text",
                                                    required: true,
                                                    value:category_element.innerText});
        category_element.innerHTML = "";
        category_element.appendChild(category);
    }

    function edit_transaction(event) {
        let id = event.target.id.split("__")[0];
        const row = event.target.parentElement;
        if (row.classList.contains("editing"))
        {
            console.log("Saving ....");
            save_edit(row);
            return;
        }

        const currently_editing = document.querySelectorAll(".editing");
        for(let i=0; i<currently_editing.length; i++) {
            revert_edit(currently_editing[i]);
        }

        if (row.classList.contains("editing"))  {
            revert_edit(row);
            return ;
        }

        row.classList.toggle("editing");

        /* Allow editing of name and category fields for parent rows only */
        if (!row.classList.contains("child")) {
            _edit_non_child(id);
        }
        else {
            let parent_id = row.getAttribute("parent_id");
            let parent_row = document.getElementById(parent_id);
            _edit_child(id, parent_row);
        }
    }

    function _toggle_edit() {
        let button = document.getElementById("toggle_edit");
        button.value = button.value==="Edit" ? "Stop Editing":"Edit";
        let edit_flag = button.value!=="Edit";
        if (!edit_flag)
            _revert_child_edits();
        let edit_buttons = document.getElementsByClassName("edit_button");
        for (let i=0; i<edit_buttons.length; i++) {
            let row = edit_buttons[i].parentElement;
            edit_buttons[i].style.display = edit_flag ? "table-cell" : "none";
            let id = row.id.split("__")[0];
            if (!row.classList.contains("child")) {
                let link_button = row.querySelector(".link_button");
                link_button.style.display = edit_flag ? "table-cell" : "none";
            }
            if (row.classList.contains("editing")) {
                revert_edit(parent);
            }
        }
    }

    function _set_year_selected_event() {
        const year_element= document.getElementById("id_year")
        year_element.addEventListener("change", function() {
            console.log("year changed");
            const year_selected = document.getElementById("year_selected").value;
            const queryString = window.location.search;
            let urlParams = new URLSearchParams(queryString);
            if (year_element.value !== year_selected) {
                if (year_element.value !== "all")
                    urlParams.set("year", year_element.value);
                else
                    urlParams.delete("year");
                urlParams.set("page", "1");
                window.location.search = urlParams.toString();
            }
        });
    }

    function _revert_child_edits(){
        /* Revert any existing edits - which means that any new rows are just thrown away */

        const table = document.getElementById("transactions");
        let any_child_editing = document.querySelectorAll("tr.editing.child");
        for (let i=0; i<any_child_editing.length; i++) {
            let parent_id = any_child_editing[i].getAttribute("parent_id");
            let parent_row = document.getElementById(parent_id);
            parent_row.classList.remove("expanded");

            let row = any_child_editing[i];
            row.classList.remove("editing")
            if (row.classList.contains("new"))
                table.deleteRow(row.rowIndex);
            else
                row.classList.remove("expanded");
        }
    }

    function _disable_edit_buttons()
    {
        let edit_buttons = document.querySelectorAll(".edit_button")
        for (i=0;i<edit_buttons.length;i++)
            edit_buttons[i].style.display = "none";
    }

    function link_edit(row_element) {
        const table = document.getElementById("transactions");

        /* Discard any other editing of child rows */
        _revert_child_edits();

        /* Expand all of the child rows */
        _expand_collapse(row_element, true);

        /* Disable all edit buttons while the child row is active */
        _disable_edit_buttons();

        _create_child_row(row_element);
    }

    function _set_edit_and_revert_event()
    {
        let rows = document.querySelectorAll(".row");
        for (let i=0; i<rows.length; i++) {
            const edit_button = rows[i].querySelector(".edit_button");
            edit_button.addEventListener("click", edit_transaction);
            const revert_button = rows[i].querySelector(".revert_button");
            revert_button.addEventListener("click", function(event) {revert_edit(event.target.parentElement)});
            const link_button = rows[i].querySelector(".link_button");
            link_button.addEventListener("click", function(event) {link_edit(event.target.parentElement)});
        }
    }

    function _expand_collapse(parent_row, force_state ) {
        const id = parent_row.id;
        const children = document.querySelectorAll(`[parent_id="${id}"]`)
        if (force_state) {
            parent_row.classList.add('expanded');
            for (let i=0; i<children.length; i++)
                children[i].classList.add('expanded')
        }
        else
        {
            parent_row.classList.toggle('expanded');
            for (let i=0; i<children.length; i++)
                children[i].classList.toggle('expanded')
        }

    }

    function _toggle_collapse() {
        let button = document.getElementById("toggle_collapse");
        const rows = document.querySelectorAll(".row.parent, .row.child");
        for (let i=0; i<rows.length; i++) {
            if (button.value==="Expand All")
                rows[i].classList.add("expanded");
            else
                rows[i].classList.remove("expanded");
        }
        button.value = button.value==="Collapse All" ? "Expand All":"Collapse All";
    }

    function _set_collapse_expand_event() {
        const rows  = document.querySelectorAll(".row.parent");
        for (let i=0; i<rows.length; i++) {
            const button = rows[i].querySelector(".col.button");
            const parent_row = rows[i]
            button.addEventListener("click", function() {
                parent_row.classList.toggle("expanded");
                let t_id = parent_row.getAttribute("t_id")
                let child_rows = document.querySelectorAll(".row.child[parent_id='" + t_id + "']");
                for (let j=0; j<child_rows.length; j++) {
                    child_rows[j].classList.toggle("expanded");
                }
            });
        }
    }

    function _on_load() {

        const account_element = document.getElementById("id_account")
        account_element.addEventListener("change", function() {
                const account = account_element.value;
                if (account == null || account.trim() === "")
                    return;
                window.location.href = "/Account/report/transactions/" + account + "/";
        });

        _set_year_selected_event();
        _set_collapse_expand_event();
        _set_edit_and_revert_event();
    }

document.addEventListener('DOMContentLoaded', _on_load);
</script>
<div>
<label for="id_account">Account</label>
    <select id='id_account' name="account">
        <option value="">Bank Account ?</option>
        {% for account in accounts %}
            <option value="{{ account.id }}" {% if account.id == account_selection %}selected{% endif %}>{{ account }}</option>
        {% endfor %}
    </select>
</div>

{% if years %}
    <div id="details">
        <div>
            <label for="id_year">Year</label><select id='id_year' name="year">
            <option value="">Filter by Calendar Year</option>
            <option value="all">All</option>
            {% for year in years %}
                <option value="{{ year }}" {% if year == year_selected %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
            </select>
            <input type="hidden" id="year_selected" value="{{ year_selected }}">
        </div>
        <div id="buttons">
            <input id="toggle_collapse" type="button" onclick="_toggle_collapse()" value="Expand All">
            <input id="toggle_edit" type="button" onclick="_toggle_edit()" value="Edit">
        </div>

        <table id="transactions">
                <tr>
                    <th class="button"></th><th class="col date">Date</th><th class="col name">Description</th><th class="col">Debit</th><th class="col">Credit</th><th class="col">Balance</th><th class="col">Category</th>
                </tr>
            {% for transaction in page_obj %}
                    <tr id='{{ transaction.id }}' class="row {% cycle 'odd' 'even' %} {% if transaction.has_children %}parent{% else %}{% endif %}" t_id={{ transaction.id }} remaining_credit="{{ transaction.remaining_credit }}" remaining_debit="{{ transaction.remaining_debit }}">
                        <td class="col {% if transaction.has_children %}button{% endif %}"></td>
                        <td class="col date">{{ transaction.transaction_date }}</td>
                        <td id='{{ transaction.id }}__name' class="col name">{{ transaction.name }}</td>
                        <td class="col debit">{{ transaction.debit|default_if_none:"" }}</td>
                        <td class="col credit">{{ transaction.credit|default_if_none:"" }}</td>
                        <td class="col balance">{{transaction.balance}}</td>
                        <td id='{{ transaction.id }}__category' class="col category">{{ transaction.category}}</td>
                        <td id='{{ transaction.id }}__edit' class="edit_button"></td>
                        <td id='{{ transaction.id }}__revert' class="revert_button"></td>
                        <td id='{{ transaction.id }}__link' class="link_button"></td>
                </tr>
                {% for split in transaction.children.all %}
                    <tr class="child row" id='{{ split.id }}' parent_id={{ transaction.id }}>
                    <td class="col"></td>
                    <td class="col date"></td>
                    <td id='{{ split.id }}__name' class="col name">{{ split.name }}</td>
                    <td id='{{ split.id }}__debit' class="col debit">{{ split.debit|default_if_none:""}}</td>
                    <td id='{{ split.id }}__credit' class="col credit">{{ split.credit|default_if_none:"" }}</td>
                    <td class="col balance"></td>
                    <td class="col category"></td>
                    <td id='{{ split.id }}__edit' class="edit_button"></td>
                    <td id='{{ split.id }}__revert' class="revert_button"></td>
                    <td id='{{ split.id }}__link' class="link_button"></td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>

        <div class="pagination" >
            <div class="step-links" >
                <div>
                    {% if page_obj.has_previous %}
                        <a href="?page=1&year={{ year_selected }}">&laquo; first</a>
                        <a href="?page={{ page_obj.previous_page_number }}&year={{ year_selected }}">previous</a>
                    {% endif %}
                </div>

                <div class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </div>

                <div>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&year={{ year_selected }}">next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&year={{ year_selected }}">last &raquo;</a>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}